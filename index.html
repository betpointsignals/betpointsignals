<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Signal Alerts â€” Bet Point</title>

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#007bff">
<link rel="apple-touch-icon" href="./icon-1024x1024.png">

<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

<style>
html, body { margin:0; height:100%; width:100%; font-family:Arial,sans-serif; background:#000; }
iframe { width:100%; height:100%; border:none; display:block; }
#loginOverlay { position:fixed; inset:0; background:#000; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:999; color:#fff; }
#loginOverlay img { width:96px; height:96px; margin-bottom:16px; }
#loginOverlay input { padding:12px; font-size:16px; width:220px; border-radius:6px; border:none; margin-bottom:12px; }
#loginOverlay button { padding:12px 18px; font-size:16px; border-radius:6px; border:none; background:#007bff; color:#fff; cursor:pointer; }
#loginError { color:#ff4d4d; margin-top:12px; }
#spinner { border:4px solid rgba(255,255,255,0.2); border-top:4px solid #007bff; border-radius:50%; width:36px; height:36px; animation:spin 1s linear infinite; margin-top:12px; display:none; }
@keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginOverlay">
  <img src="./icon-1024x1024.png" alt="Logo">
  <h2>Enter Password</h2>
  <input type="password" id="rowIdInput" placeholder="Password">
  <button id="loginBtn">Submit</button>
  <div id="loginError"></div>
  <div id="spinner"></div>
</div>

<!-- APP -->
<iframe id="appFrame"></iframe>

<script>
/* ================= CONFIG ================= */
const LOGIN_SUBMIT_URL = 'https://your-supabase/functions/v1/login-submit'; // triggers row insert
const CHECKLAST_URL   = 'https://your-supabase/functions/v1/checklast-login'; // returns latest code
const REGISTER_URL    = 'https://your-supabase/functions/v1/register-device';
const APP_URL         = 'https://bet-point.appsmith.com/app/signals/page1-68b217383a43874978908b5c?embed=true';
const deviceType      = /Mobi|Android/i.test(navigator.userAgent) ? 'mobile' : 'web';
const ONESIGNAL_APP_ID = "2b94ad70-2518-44d4-aaef-bfb95739206f";

let rowId = null;
let loginCode = null;
let checkInterval = null;
let autoLoginDisabled = false;
let isSubmitting = false;

/* ================= HELPERS ================= */
function getUrlParam(name) {
  return new URLSearchParams(window.location.search).get(name);
}

/* ================= AUTH STATE ================= */
function setAuthState(isAuthed, reason = null) {
  const overlay = document.getElementById('loginOverlay');
  const frame = document.getElementById('appFrame');

  if (isAuthed) {
    overlay.style.display = 'none';
    frame.src = APP_URL;
    startCheckLoop();
  } else {
    localStorage.removeItem('rowId');
    localStorage.removeItem('loginCode');
    frame.src = 'about:blank';
    overlay.style.display = 'flex';
    stopCheckLoop();
    console.warn("Auth revoked:", reason);
    autoLoginDisabled = true; // ðŸ”¹ prevent auto-login until manual login
  }
}

/* ================= AUTO LOGIN ================= */
window.addEventListener('DOMContentLoaded', () => {
  // Only restore session without inserting a new row
  if (autoLoginDisabled) return;

  const savedRowId = localStorage.getItem('rowId');
  const savedCode  = localStorage.getItem('loginCode');

  if (savedRowId && savedCode) {
    rowId = savedRowId;
    loginCode = savedCode;
    setAuthState(true); // access without creating a new row
    initOneSignal(rowId);
  }
});

/* ================= LOGIN SUBMIT ================= */
async function submitRowId(e) {
  if (e) e.preventDefault();
  if (isSubmitting) return;
  isSubmitting = true;
  autoLoginDisabled = false; // manual login allowed

  const error = document.getElementById('loginError');
  const spinner = document.getElementById('spinner');
  rowId = document.getElementById('rowIdInput').value.trim();
  if (!rowId) {
    isSubmitting = false;
    return;
  }

  error.textContent = '';
  spinner.style.display = 'block';

  try {
    // ðŸ”¹ call login-submit to insert a new row
    const res = await fetch(LOGIN_SUBMIT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ row_id: rowId })
    });

    const data = await res.json();
    console.log("login-submit response:", data);

    if (!data.success || !data.row) {
      error.textContent = 'Login failed';
      return;
    }

    loginCode = data.row.code;
    localStorage.setItem('rowId', rowId);
    localStorage.setItem('loginCode', loginCode);

    setAuthState(true);
    initOneSignal(rowId);

  } catch (err) {
    console.error("Login error:", err);
    error.textContent = 'Server error';
  } finally {
    spinner.style.display = 'none';
    isSubmitting = false;
  }
}

/* ================= POLL LATEST SESSION ================= */
async function checkLastLogin() {
  if (!rowId || !loginCode) return;

  try {
    const res = await fetch(CHECKLAST_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ row_id: rowId })
    });

    const data = await res.json();
    console.log('checklast-login response:', data);

    // ðŸ”¹ Force logout if code changed
    if (!data.success || data.code !== loginCode) {
      setAuthState(false, 'session replaced');
    }

  } catch (err) {
    console.error('checklast-login error:', err);
    setAuthState(false, 'checklast exception');
  }
}

function startCheckLoop() {
  stopCheckLoop();
  checkInterval = setInterval(checkLastLogin, 5000);
}

function stopCheckLoop() {
  if (checkInterval) {
    clearInterval(checkInterval);
    checkInterval = null;
  }
}

/* ================= ONESIGNAL ================= */
function initOneSignal(rowId) {
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: ONESIGNAL_APP_ID,
      path: "/signals/",
      serviceWorkerPath: "signals/OneSignalSDKWorker.js",
      serviceWorkerUpdaterPath: "signals/OneSignalSDKUpdaterWorker.js",
      notifyButton: { enable: true }
    });

    try {
      await OneSignal.login(rowId);
      const playerId = await OneSignal.getUserId();

      await fetch(REGISTER_URL, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          rowId,
          loginCode,
          one_signal_id: playerId,
          device_type: deviceType
        })
      });

      console.log("OneSignal ready");
    } catch (err) {
      console.error("OneSignal error:", err);
    }
  });
}

/* ================= ENTER KEY SUBMIT ================= */
document.getElementById('rowIdInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') submitRowId(e);
});
document.getElementById('loginBtn').addEventListener('click', submitRowId);

</script>
</body>
</html>
